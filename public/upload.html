<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Azure Upload</title>
  </head>
  <body>
    <h2>System Status: <span id="status">Loading...</span></h2>
    <div>Server time: <span id="time">...</span></div>

    <hr />

    <h2>Upload</h2>

    <div style="margin-bottom: 8px">
      <label>
        Password:
        <input id="pw" name="pw" type="password" autocomplete="current-password" />
      </label>
      <span id="pwMsg" style="margin-left: 8px"></span>
    </div>

    <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
      <input type="hidden" name="pw" id="pwHidden" />
      <input type="file" name="file" />
      <button id="uploadBtn" type="submit" disabled>Upload</button>
    </form>

    <hr />

    <h2>Files</h2>
    <div id="list">Loading...</div>

    <script>
      const pwInput = document.getElementById("pw");
      const pwHidden = document.getElementById("pwHidden");
      const uploadBtn = document.getElementById("uploadBtn");
      const pwMsg = document.getElementById("pwMsg");
      const listEl = document.getElementById("list");

      let timer = null;
      let authed = false;

      function setLocked(msg) {
        authed = false;
        uploadBtn.disabled = true;
        pwMsg.textContent = msg || "";
        pwMsg.style.color = "crimson";
      }

      function setUnlocked(msg) {
        authed = true;
        uploadBtn.disabled = false;
        pwMsg.textContent = msg || "";
        pwMsg.style.color = "green";
      }

      async function checkPassword(pw) {
        if (!pw) {
          setLocked("Enter password");
          return false;
        }

        try {
          const r = await fetch("/auth/check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pw }),
          });

          if (r.ok) {
            setUnlocked("OK");
            return true;
          }

          setLocked("Wrong password");
          return false;
        } catch (e) {
          setLocked("Connection error");
          return false;
        }
      }

      pwInput.addEventListener("input", () => {
        const pw = pwInput.value;
        pwHidden.value = pw;

        uploadBtn.disabled = true;
        pwMsg.textContent = "Checking...";
        pwMsg.style.color = "gray";

        clearTimeout(timer);
        timer = setTimeout(() => checkPassword(pw), 300);
      });

      document.getElementById("uploadForm").addEventListener("submit", (e) => {
        pwHidden.value = pwInput.value;
        if (!authed) e.preventDefault();
      });

      async function loadStatus() {
        try {
          const r = await fetch("/status");
          const data = await r.json();
          document.getElementById("status").textContent = data.status || "Unknown";
          document.getElementById("time").textContent = data.serverTime || "";
        } catch (e) {
          document.getElementById("status").textContent = "Error";
        }
      }

      async function deleteFile(name) {
        const pw = pwInput.value;

        if (!pw) {
          alert("Enter password");
          return;
        }

        const okPw = await checkPassword(pw);
        if (!okPw) return;

        const confirmDelete = confirm(`Delete file: ${name} ?`);
        if (!confirmDelete) return;

        try {
          const r = await fetch("/file/" + encodeURIComponent(name), {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pw }),
          });

          if (!r.ok) {
            const t = await r.text();
            alert("Delete failed: " + t);
            return;
          }

          await loadFiles();
        } catch (e) {
          alert("Connection error");
        }
      }

      async function loadFiles() {
        listEl.textContent = "Loading...";

        try {
          const r = await fetch("/files");
          const data = await r.json();

          listEl.innerHTML = "";

          if (!data.files || data.files.length === 0) {
            listEl.textContent = "No files yet.";
            return;
          }

          data.files.forEach((name) => {
            const wrap = document.createElement("div");
            wrap.style.marginBottom = "12px";

            const row = document.createElement("div");

            const a = document.createElement("a");
            a.href = "/file/" + encodeURIComponent(name);
            a.textContent = name;
            a.target = "_blank";
            row.appendChild(a);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.style.marginLeft = "10px";
            delBtn.addEventListener("click", () => deleteFile(name));
            row.appendChild(delBtn);

            wrap.appendChild(row);

            if (name.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
              const img = document.createElement("img");
              img.src = "/file/" + encodeURIComponent(name);
              img.style.display = "block";
              img.style.maxWidth = "320px";
              img.style.marginTop = "6px";
              wrap.appendChild(img);
            }

            listEl.appendChild(wrap);
          });
        } catch (e) {
          listEl.textContent = "Failed to load files.";
        }
      }

      setLocked("Enter password");
      loadStatus();
      loadFiles();
    </script>
  </body>
</html>

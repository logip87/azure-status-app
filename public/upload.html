<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Azure Upload</title>
</head>
<body>
  <h2>System Status: <span id="status">Loading...</span></h2>
  <div>Server time: <span id="time">...</span></div>

  <hr/>

  <h2>Upload</h2>

  <div style="margin-bottom: 8px;">
    <label>
      Hasło:
      <input id="pw" name="pw" type="password" autocomplete="current-password" />
    </label>
    <span id="pwMsg" style="margin-left:8px;"></span>
  </div>

  <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
    <input type="hidden" name="pw" id="pwHidden" />
    <input type="file" name="file" />
    <button id="uploadBtn" type="submit" disabled>Upload</button>
  </form>

  <hr/>

  <h2>Files</h2>
  <div id="list">Loading...</div>

  <script>
    const pwInput = document.getElementById("pw");
    const pwHidden = document.getElementById("pwHidden");
    const uploadBtn = document.getElementById("uploadBtn");
    const pwMsg = document.getElementById("pwMsg");

    let timer = null;

    function setLocked(msg) {
      uploadBtn.disabled = true;
      pwMsg.textContent = msg || "";
      pwMsg.style.color = "crimson";
    }

    function setUnlocked(msg) {
      uploadBtn.disabled = false;
      pwMsg.textContent = msg || "";
      pwMsg.style.color = "green";
    }

    async function checkPassword(pw) {
      if (!pw || pw.length < 1) {
        setLocked("Wpisz hasło");
        return;
      }

      try {
        const r = await fetch("/auth/check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pw })
        });

        if (r.ok) setUnlocked("OK");
        else setLocked("Złe hasło");
      } catch (e) {
        setLocked("Błąd połączenia");
      }
    }

    pwInput.addEventListener("input", () => {
      const pw = pwInput.value;
      pwHidden.value = pw;

      uploadBtn.disabled = true;
      pwMsg.textContent = "Sprawdzam...";
      pwMsg.style.color = "gray";

      clearTimeout(timer);
      timer = setTimeout(() => checkPassword(pw), 400);
    });

    document.getElementById("uploadForm").addEventListener("submit", (e) => {
      pwHidden.value = pwInput.value;
      if (uploadBtn.disabled) {
        e.preventDefault();
      }
    });

    async function loadStatus() {
      try {
        const r = await fetch("/status");
        const data = await r.json();
        document.getElementById("status").textContent = data.status || "Unknown";
        document.getElementById("time").textContent = data.serverTime || "";
      } catch (e) {
        document.getElementById("status").textContent = "Error";
      }
    }

    async function loadFiles() {
      const el = document.getElementById("list");
      el.textContent = "Loading...";

      try {
        const r = await fetch("/files");
        const data = await r.json();

        el.innerHTML = "";

        if (!data.files || data.files.length === 0) {
          el.textContent = "No files yet.";
          return;
        }

        data.files.forEach(name => {
          const wrap = document.createElement("div");
          wrap.style.marginBottom = "12px";

          const a = document.createElement("a");
          a.href = "/file/" + encodeURIComponent(name);
          a.textContent = name;
          a.target = "_blank";
          wrap.appendChild(a);

          if (name.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
            const img = document.createElement("img");
            img.src = "/file/" + encodeURIComponent(name);
            img.style.display = "block";
            img.style.maxWidth = "320px";
            img.style.marginTop = "6px";
            wrap.appendChild(img);
          }

          el.appendChild(wrap);
        });
      } catch (e) {
        el.textContent = "Failed to load files.";
      }
    }

    setLocked("Wpisz hasło");
    loadStatus();
    loadFiles();
  </script>
</body>
</html>

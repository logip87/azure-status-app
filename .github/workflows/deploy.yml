name: ci-cd

on:
  push:
    branches: ["main"]
    paths:
      - "server.js"
      - "public/**"
      - "tests/**"
      - "package*.json"
      - ".github/workflows/**"
  workflow_dispatch:

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_test_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      # Cache Playwright browsers to speed up builds
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Package app
        run: |
          zip -r app.zip . \
            -x "node_modules/*" \
               ".git/*" \
               ".github/*" \
               "test-results/*" \
               "playwright-report/*" \
               ".playwright/*" \
               "*.zip" \
               "*.md" \
               "infra/*"

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Deploy infra only when infra files changed (skip on pure app changes)
      - name: Detect infra changes
        id: infra
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^infra/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy app resources (Bicep)
        if: steps.infra.outputs.changed == 'true'
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az deployment group create \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --template-file infra/app.bicep \
              --parameters \
                appName="${{ vars.AZURE_WEBAPP_NAME }}" \
                planName="${{ vars.AZURE_APP_SERVICE_PLAN }}" \
                storageAccountName="${{ vars.AZURE_STORAGE_ACCOUNT }}" \
                containerName="${{ vars.AZURE_STORAGE_CONTAINER }}" \
                logAnalyticsName="${{ vars.AZURE_LOG_ANALYTICS_NAME }}" \
                appInsightsName="${{ vars.AZURE_APP_INSIGHTS_NAME }}" \
                uploadPassword="${{ secrets.UPLOAD_PASSWORD }}"

      - name: Deploy zip to Web App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az webapp deploy \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --name "${{ vars.AZURE_WEBAPP_NAME }}" \
              --src-path app.zip \
              --type zip

      - name: Run Playwright tests (smoke)
        run: npx playwright test
        env:
          CI: "true"
          APP_URL: ${{ vars.APP_URL }}
          EXPECTED_FILE: ${{ vars.EXPECTED_FILE }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results
          if-no-files-found: warn
